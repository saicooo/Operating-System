/*
 * ======================================================================
 * Лабораторная работа 2, задание 5.2 (приоритеты процессов)
 * ======================================================================
 *
 * ЗАДАЧА:
 * Исследование команды nice(1) и системного вызова getpriority(2) для
 * управления приоритетами процессов. Анализ возможностей изменения
 * приоритетов системных и пользовательских процессов и реакции системы.
 *
 * ЧТО ДЕЛАЕТ ПРОГРАММА:
 * Программа демонстрирует работу с приоритетами процессов в Linux.
 * Она получает и выводит текущий приоритет (nice value) процесса,
 * пытается изменить приоритет различными способами (setpriority и nice),
 * а также пытается получить и изменить приоритет системного процесса.
 * После каждой операции выводится текущее значение nice.
 *
 * КОМПИЛЯЦИЯ И ЗАПУСК:
 * $ gcc prog.c -o prog
 * $ ./prog
 *
 * РЕЗУЛЬТАТЫ И ВЫВОДЫ:
 * - Показывает начальное значение nice для пользовательского процесса
 * - Демонстрирует возможность повышения nice (понижения приоритета)
 *   через setpriority и nice для своих процессов
 * - Показывает ограничения при попытке понизить nice (повысить приоритет)
 *   без прав суперпользователя
 * - Иллюстрирует ограничения при попытке изменения приоритетов
 *   системных процессов
 */

#include <errno.h>
#include <sched.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/resource.h>
#include <sys/wait.h>
#include <unistd.h>

// Функция получения приоритета для данного процесса
void print_priority(int which, id_t who) {
    int priority = getpriority(which, who);
    if (errno != 0) {
        fprintf(stderr, "Ошибка getpriority: не удается получить значение\n");
    }

    printf("nice = [%d]\n", priority);
}

int main() {
    // Отключаем буферизацию
    setbuf(stdout, NULL);
    setbuf(stderr, NULL);

    // Получаем приоритет текущего процесса
    printf("\n--- Вычисляем приоритет для текущего процесса ---\n");
    print_priority(PRIO_PROCESS, 0);

    // Пытаемся изменить значение приоритета текущего процесса через setpriority
    printf("\n--- Изменяем приоритет для текущего процесса через setpriority ---\n");

    if (setpriority(PRIO_PROCESS, 0, 15) == -1) {
        fprintf(stderr, "Ошибка setpriority: не удается изменить значение\n");
    }

    // Выводим результат изменения
    print_priority(PRIO_PROCESS, 0);

    // Пытаемся изменить значение приоритета текущего процесса через nice (относительное изменение)
    printf("\n--- Изменяем приоритет для текущего процесса через nice ---\n");

    if (nice(-1) == -1) {
        fprintf(stderr, "Ошибка nice: не удается изменить значение\n");
    }

    // Выводим результат изменения
    print_priority(PRIO_PROCESS, 0);

    // Получаем приоритет системного процесса (systemd/init)
    printf("\n--- Вычисляем приоритет для системного процесса ---\n");
    print_priority(PRIO_PROCESS, 1);

    // Пытаемся изменить значение приоритета системного процесса через setpriority
    printf("\n--- Изменяем приоритет для системного процесса через setpriority ---\n");

    if (setpriority(PRIO_PROCESS, 1, 15) == -1) {
        fprintf(stderr, "Ошибка setpriority: не удается изменить значение\n");
    }

    // Выводим результат изменения
    print_priority(PRIO_PROCESS, 1);

    return 0;
}