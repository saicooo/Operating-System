/*
 * ======================================================================
 * Лабораторная работа 2, задание 2.4 (дочерний процесс)
 * ======================================================================
 *
 * ЗАДАЧА:
 * Вспомогательная программа для демонстрации трех различных сценариев
 * взаимодействия родительского и дочернего процессов.
 *
 * ЧТО ДЕЛАЕТ ПРОГРАММА:
 * В зависимости от переданного аргумента ('a', 'b' или 'c'):
 * а) Выполняет короткие действия и завершается (нормальное завершение)
 * б) Выполняет действия с длительной задержкой (для демонстрации orphan)
 * в) Быстро завершается, чтобы стать zombie-процессом
 *
 * Каждый сценарий включает вывод информации о PID и PPID процесса и,
 * при необходимости, показывает вывод команды ps для демонстрации
 * состояния процессов.
 *
 * КОМПИЛЯЦИЯ И ЗАПУСК:
 * $ gcc son.c -o son
 * (Обычно запускается из father.c через execl, но можно запустить и напрямую)
 * $ ./son a  # Сценарий A
 * $ ./son b  # Сценарий B
 * $ ./son c  # Сценарий C
 */

#include <stdio.h>
#include <stdlib.h>
#include <sys/types.h>
#include <unistd.h>

int main(int argc, char *argv[]) {
    // Отключаем буферизацию
    setbuf(stdout, NULL);
    setbuf(stderr, NULL);

    if (argc < 2) {
        fprintf(stderr, "Использование: %s <сценарий a|b|c>\n", argv[0]);
        return EXIT_FAILURE;
    }

    char cmd[256];
    sprintf(cmd, "\n--- Информация о son ---\nPID=[%d], PPID=[%d]\n\n", getpid(), getppid());
    printf("%s", cmd);

    char scenario = argv[1][0];
    switch (scenario) {
        case 'a':     // Нормальное завершение
            sleep(3); // имитация работы
            // Просто выходим - родитель ждет
            break;

        case 'b': // Orphan процесс
            // Показываем таблицу процессов
            sprintf(cmd, "echo '\n--- Вывод ps от процесса-сироты (PID=%d) ---' &&  ps -l",
                    getpid());
            system(cmd);

            sprintf(cmd,
                    "echo '\n--- Новый родитель для процесса-сироты (PID=%d) ---' && ps -lp $(ps -o ppid= "
                    "-p %d)",
                    getpid(), getpid());
            system(cmd);
            break;

        case 'c': // Zombie процесс
            // Быстро завершаемся, родитель не успеет нас подобрать
            break;

        default:
            fprintf(stderr, "Неизвестный сценарий: %c\n", scenario);
            return EXIT_FAILURE;
    }

    return 0;
}